<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio Flash - PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8B5CF6">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .card-flip-container { perspective: 1000px; }
        .card { transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05); }
        .card-front { background-color: #fff; color: #374151; }
        .card-back { background-color: #8B5CF6; color: #fff; transform: rotateY(180deg); }
        .nav-item.active { color: #8B5CF6; border-bottom: 2px solid #8B5CF6; }
        .modal { display: none; }
        .modal.flex { display: flex; }
    </style>
</head>
<body class="text-gray-800">
<div id="app" class="max-w-4xl mx-auto p-4 pb-24">
    <div id="main-content"></div>
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg max-w-4xl mx-auto border-t">
        <div class="flex justify-around">
            <button onclick="navigate('home')" class="nav-item flex-1 text-center py-4 text-gray-500 active">
                <i class="fas fa-home text-xl"></i>
                <span class="block text-xs">Inicio</span>
            </button>
            <button onclick="navigate('study')" class="nav-item flex-1 text-center py-4 text-gray-500">
                <i class="fas fa-book-open text-xl"></i>
                <span class="block text-xs">Estudiar</span>
            </button>
            <button onclick="navigate('goals')" class="nav-item flex-1 text-center py-4 text-gray-500">
                <i class="fas fa-bullseye text-xl"></i>
                <span class="block text-xs">Metas</span>
            </button>
        </div>
    </nav>
</div>

<input type="file" id="import-backup-input" class="hidden" accept=".json" onchange="handleBackupFileSelect(event)">

<div id="import-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h2 class="text-2xl font-bold mb-4">Importar Tarjetas</h2>
        <p class="text-gray-600 mb-2">Pega tu lista. Usa este formato:</p>
        <pre class="bg-gray-100 p-3 rounded text-sm mb-4 overflow-auto">Pregunta 1<br>---<br>Respuesta 1<br><br>Pregunta 2<br>---<br>Respuesta 2</pre>
        <textarea id="bulk-import-text" class="w-full h-48 p-2 border rounded-lg focus:ring-2 focus:ring-violet-500" placeholder="Pega tus tarjetas aquí..."></textarea>
        <div class="flex justify-end gap-4 mt-4">
            <button onclick="closeImportModal()" class="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancelar</button>
            <button onclick="importCards()" class="bg-violet-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-violet-700 transition-colors">Importar</button>
        </div>
    </div>
</div>

<div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
        <i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">¿Estás seguro?</h2>
        <p id="confirm-modal-text" class="text-gray-600 mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="confirm-modal-cancel" class="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancelar</button>
            <button id="confirm-modal-confirm" class="bg-red-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-red-700 transition-colors">Sí, continuar</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<script>
// ---------------------- TU JS COMPLETO ----------------------
let state = {
    subjects: [],
    currentView: 'home',
    selectedSubjectId: null,
    selectedTopicId: null,
    studySession: {
        cards: [],
        currentIndex: 0,
        correct: 0,
        incorrect: 0
    }
};

const synth = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();

const correctSound = () => synth.triggerAttackRelease("G5", "16n", Tone.now());
const incorrectSound = () => synth.triggerAttackRelease("E3", "16n", Tone.now());

// Guardar y cargar datos
function saveData() { localStorage.setItem('flashcardApp', JSON.stringify(state)); }
function loadData() {
    const data = localStorage.getItem('flashcardApp');
    if (data) {
        const loadedState = JSON.parse(data);
        loadedState.subjects.forEach(subject => {
            subject.topics.forEach(topic => {
                topic.cards.forEach(card => {
                    if (card.repetition === undefined) {
                        card.repetition = 0;
                        card.interval = 1;
                        card.easeFactor = 2.5;
                        card.dueDate = new Date().toISOString();
                    }
                });
            });
        });
        state = loadedState;
    } else {
        state.subjects = [
            { id: 1, name: 'Matemáticas', topics: [{ id: 1, name: 'Teoría de Conjuntos', cards: [{ id: 1, question: '¿Qué es un conjunto?', answer: 'Una colección de elementos distintos.', repetition: 0, interval: 1, easeFactor: 2.5, dueDate: new Date().toISOString() }, { id: 2, question: '¿Qué es la unión de dos conjuntos A y B?', answer: 'Un conjunto con todos los elementos de A y B.', repetition: 0, interval: 1, easeFactor: 2.5, dueDate: new Date().toISOString() }] }] },
            { id: 2, name: 'Historia', topics: [] }
        ];
    }
}

// Navegación y renderizado
function navigate(view, params = {}) {
    state.currentView = view;
    if (params.subjectId !== undefined) state.selectedSubjectId = params.subjectId;
    if (params.topicId !== undefined) state.selectedTopicId = params.topicId;
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`.nav-item[onclick="navigate('${view.split('_')[0]}')"]`);
    if (activeItem) activeItem.classList.add('active');
    render();
}

function render() {
    const mainContent = document.getElementById('main-content');
    switch (state.currentView) {
        case 'home':
            mainContent.innerHTML = renderHome();
            break;
        case 'subject_details':
            mainContent.innerHTML = renderSubjectDetails();
            break;
        case 'topic_details':
            mainContent.innerHTML = renderTopicDetails();
            break;
        case 'study':
            mainContent.innerHTML = renderStudySelection();
            break;
        case 'study_session':
            mainContent.innerHTML = renderStudySession();
            break;
        case 'goals':
            mainContent.innerHTML = renderGoals();
            break;
    }
}

// ---------------------- AQUÍ SIGUE TODO TU JS ----------------------
// Copia tal cual todo tu código de funciones renderHome, renderSubjectDetails, 
// renderTopicDetails, renderStudySelection, renderStudySession, renderGoals, 
// y todas las funciones de manejo de tarjetas, import/export, modales, sonidos, etc.
// ---------------------- FIN JS ----------------------
loadData();
render();
</script>

<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
            .catch(err => console.log('ServiceWorker registration failed: ', err));
    });
}
</script>
</body>
</html>